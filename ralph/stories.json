{
  "project": "Eclipse OBD-II",
  "branchName": "ralph/remote-ollama",
  "description": "B-016: Remote Ollama Server Integration",
  "userStories": [
    {
      "id": "US-OLL-004",
      "title": "Write Tests for Remote Ollama Scenarios",
      "description": "As a developer, I need tests that verify OllamaManager works correctly with remote URLs and handles failure scenarios. TDD: write tests FIRST, then implement US-OLL-001/002/003.",
      "acceptanceCriteria": [
        "Create tests/test_remote_ollama.py with standard file header per specs/standards.md",
        "Test: OllamaManager initializes with a non-localhost URL from config",
        "Test: _checkNetworkReachable returns False for an unreachable host (use non-routable IP 192.0.2.1)",
        "Test: _checkNetworkReachable returns True when socket connects (mock socket)",
        "Test: Health check skips Ollama HTTP check when network is unreachable",
        "Test: Configurable timeouts are read from config and used in requests (mock urllib)",
        "Test: ollamaBaseUrl with ${OLLAMA_BASE_URL:default} resolves correctly through secrets_loader",
        "Test: State is UNAVAILABLE when remote server is down, with appropriate error message",
        "Test: Graceful fallback -- AI analysis returns without crash when remote is unreachable",
        "Tests use monkeypatch or unittest.mock for network operations (no real network calls)",
        "All tests pass, typecheck passes"
      ],
      "priority": "high",
      "passes": false,
      "notes": "",
      "dependencies": []
    },
    {
      "id": "US-OLL-001",
      "title": "Make Ollama Base URL Environment-Variable Configurable",
      "description": "As a developer, I need the Ollama base URL to support environment variable substitution so the Pi can use a different URL than the dev machine without changing config.json. Change ollamaBaseUrl in src/obd_config.json from hardcoded to ${OLLAMA_BASE_URL:http://localhost:11434}.",
      "acceptanceCriteria": [
        "Change ollamaBaseUrl in src/obd_config.json from http://localhost:11434 to ${OLLAMA_BASE_URL:http://localhost:11434}",
        "Verify secrets_loader.py resolves the placeholder correctly (it already supports ${VAR:default} syntax)",
        "Dev machine continues to work with localhost default (no .env change needed)",
        "Pi can override via .env: OLLAMA_BASE_URL=http://10.27.27.100:11434",
        "All existing tests pass (the default value is unchanged)",
        "Typecheck passes"
      ],
      "priority": "high",
      "passes": false,
      "notes": "",
      "dependencies": ["US-OLL-004"]
    },
    {
      "id": "US-OLL-002",
      "title": "Increase Timeouts for Remote Network Latency",
      "description": "As a developer, I need the API timeout to be configurable for remote servers where network latency adds to response time. Currently hardcoded in src/ai/types.py.",
      "acceptanceCriteria": [
        "Add aiAnalysis.apiTimeoutSeconds to src/obd_config.json with default 60 (was hardcoded 30s in types.py)",
        "Add aiAnalysis.healthTimeoutSeconds to src/obd_config.json with default 10 (was hardcoded 5s in types.py)",
        "OllamaManager.__init__ reads these values from config, falling back to the current constants if not present",
        "Pass configurable timeout to urllib.request.urlopen() calls instead of the constants",
        "Existing tests continue to pass (defaults are compatible)",
        "Typecheck passes"
      ],
      "priority": "medium",
      "passes": false,
      "notes": "",
      "dependencies": ["US-OLL-001"]
    },
    {
      "id": "US-OLL-003",
      "title": "Add Network Reachability Pre-Check",
      "description": "As a developer, I need the AI module to check network reachability to the Ollama host before attempting analysis, so it fails fast when WiFi is unavailable.",
      "acceptanceCriteria": [
        "Add a _checkNetworkReachable(self) -> bool method to OllamaManager",
        "Method extracts hostname from self._baseUrl and attempts a socket connection on the configured port with a 3-second timeout",
        "Method is called before _checkOllamaAvailable() in the health check flow",
        "If network unreachable: sets state to UNAVAILABLE, logs 'Network unreachable: <host>:<port>' at DEBUG level",
        "If network reachable: proceeds to normal Ollama health check",
        "Does not affect behavior when Ollama is on localhost (socket connect to localhost is fast)",
        "All existing tests pass, typecheck passes"
      ],
      "priority": "medium",
      "passes": false,
      "notes": "",
      "dependencies": ["US-OLL-002"]
    },
    {
      "id": "US-OLL-005",
      "title": "Create Ollama Server Setup Documentation",
      "description": "As the CIO, I need documentation on how to set up the Ollama server on Chi-srv-01 (10.27.27.100) so the Pi can connect to it.",
      "acceptanceCriteria": [
        "Create docs/ollama-server-setup.md",
        "Document: choosing a host machine (minimum specs: 8GB RAM, GPU recommended) - reference Chi-srv-01 as example",
        "Document: installing Ollama on the server (curl -fsSL https://ollama.com/install.sh | sh)",
        "Document: configuring Ollama to listen on all interfaces (OLLAMA_HOST=0.0.0.0)",
        "Document: pulling the required model (ollama pull gemma2:2b)",
        "Document: verifying the server is accessible (curl http://10.27.27.100:11434/)",
        "Document: firewall rules (allow port 11434 from Pi IP 10.27.27.28 or LAN subnet 10.27.27.0/24)",
        "Document: Pi-side configuration (set OLLAMA_BASE_URL=http://10.27.27.100:11434 in .env)",
        "Document: troubleshooting (connection refused, timeout, model not found)",
        "Document: optional systemd service for auto-start on the server",
        "Typecheck passes (n/a for docs, but no code changes should break typecheck)"
      ],
      "priority": "low",
      "passes": false,
      "notes": "",
      "dependencies": ["US-OLL-003"]
    }
  ]
}
