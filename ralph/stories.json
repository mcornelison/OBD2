{
  "project": "Eclipse OBD-II",
  "branchName": "ralph/database-verify-and-remote-ollama",
  "description": "B-015: Database Verify & Init Script + B-016: Remote Ollama Server Integration",
  "userStories": [
    {
      "id": "US-DBI-004",
      "title": "Write Tests for Database Verify Script",
      "description": "As a developer, I need tests that verify the script works on fresh and populated databases. TDD: write tests FIRST, then implement US-DBI-001/002/003.",
      "acceptanceCriteria": [
        "Create tests/test_verify_database.py with standard file header per specs/standards.md",
        "Test: verifyDatabase on a fresh temp database returns allPassed: False (no tables)",
        "Test: initializeAndVerify on a fresh temp database returns allPassed: True",
        "Test: verifyDatabase on an initialized database returns allPassed: True",
        "Test: verifyDatabase on a database missing one table returns allPassed: False with that table marked False",
        "Test: initializeAndVerify on a populated database preserves existing records (insert test data before, verify after)",
        "Test: WAL mode verification returns True when enabled",
        "Test: record counts are correct after inserting test data",
        "Test: CLI returns exit code 0 on success, 1 on failure (subprocess test)",
        "Tests use tmp_path fixture for temp databases",
        "All tests pass, typecheck passes"
      ],
      "priority": "high",
      "passes": true,
      "notes": "14 tests written and passing. Tests cover: fresh db (allPassed:False), initialized db (allPassed:True), missing table, WAL mode, record counts, CLI exit codes, initializeAndVerify preserves data.",
      "dependencies": []
    },
    {
      "id": "US-DBI-001",
      "title": "Create Database Verify Script (CLI)",
      "description": "As a developer, I need a CLI script that checks whether the database is correctly initialized and reports status. Import ALL_SCHEMAS and ALL_INDEXES from src/obd/database.py -- do NOT hardcode table names.",
      "acceptanceCriteria": [
        "Create scripts/verify_database.py with standard file header per specs/standards.md",
        "Accepts --db-path argument (default: value from src/obd_config.json database.path, resolved via secrets_loader)",
        "Accepts --verbose flag for detailed output",
        "Checks that the database file exists (or can be created)",
        "Verifies all 11 tables exist by querying sqlite_master",
        "Verifies all 10 indexes exist by querying sqlite_master",
        "Verifies WAL journal mode is active (PRAGMA journal_mode)",
        "Reports record count per table",
        "Reports database file size (human-readable: KB/MB)",
        "Reports WAL file size if present",
        "Prints a summary with PASS/FAIL for each check",
        "Returns exit code 0 if all checks pass, 1 if any check fails",
        "Uses camelCase naming per project standards",
        "All tests pass, typecheck passes"
      ],
      "priority": "high",
      "passes": true,
      "notes": "Implemented as part of US-DBI-004 TDD. CLI with --db-path, --verbose, --init flags. Imports ALL_SCHEMAS/ALL_INDEXES from database.py.",
      "dependencies": ["US-DBI-004"]
    },
    {
      "id": "US-DBI-002",
      "title": "Add Initialize Mode to Verify Script",
      "description": "As a developer, I need the verify script to optionally create and initialize the database if it doesn't exist or is missing tables. Uses existing idempotent ObdDatabase.initialize() from src/obd/database.py.",
      "acceptanceCriteria": [
        "Accepts --init flag that triggers database initialization before verification",
        "When --init is set: calls ObdDatabase.initialize() from src/obd/database.py",
        "When --init is NOT set: only verifies (read-only, no schema changes)",
        "Initialization uses the existing idempotent initialize() method (CREATE IF NOT EXISTS)",
        "After initialization, runs the full verification from US-DBI-001",
        "Prints [INIT] Created database at <path> or [INIT] Database already exists at <path>",
        "No data is lost if --init is run on a database with existing data",
        "All tests pass, typecheck passes"
      ],
      "priority": "high",
      "passes": true,
      "notes": "Implemented as part of US-DBI-004 TDD. --init flag calls ObdDatabase.initialize(), prints [INIT] messages, preserves existing data.",
      "dependencies": ["US-DBI-001"]
    },
    {
      "id": "US-DBI-003",
      "title": "Make Verify Script Importable as Module",
      "description": "As a developer, I need the verify/init logic importable so the deploy script and orchestrator can call it programmatically.",
      "acceptanceCriteria": [
        "Script uses if __name__ == '__main__' guard for CLI entry point",
        "Core logic in a verifyDatabase(dbPath: str) -> dict function that returns a results dict",
        "Results dict contains: {tables: {name: bool}, indexes: {name: bool}, walMode: bool, recordCounts: {name: int}, fileSizeBytes: int, allPassed: bool}",
        "initializeAndVerify(dbPath: str) -> dict function that initializes then verifies",
        "Both functions are importable: from scripts.verify_database import verifyDatabase, initializeAndVerify",
        "Functions raise no exceptions on verification failure -- they return results with allPassed: False",
        "All tests pass, typecheck passes"
      ],
      "priority": "high",
      "passes": true,
      "notes": "Implemented as part of US-DBI-004 TDD. Functions importable via 'from scripts.verify_database import verifyDatabase, initializeAndVerify'. No exceptions on failure.",
      "dependencies": ["US-DBI-002"]
    },
    {
      "id": "US-OLL-004",
      "title": "Write Tests for Remote Ollama Scenarios",
      "description": "As a developer, I need tests that verify OllamaManager works correctly with remote URLs and handles failure scenarios. TDD: write tests FIRST, then implement US-OLL-001/002/003.",
      "acceptanceCriteria": [
        "Create tests/test_remote_ollama.py with standard file header per specs/standards.md",
        "Test: OllamaManager initializes with a non-localhost URL from config",
        "Test: _checkNetworkReachable returns False for an unreachable host (use non-routable IP 192.0.2.1)",
        "Test: _checkNetworkReachable returns True when socket connects (mock socket)",
        "Test: Health check skips Ollama HTTP check when network is unreachable",
        "Test: Configurable timeouts are read from config and used in requests (mock urllib)",
        "Test: ollamaBaseUrl with ${OLLAMA_BASE_URL:default} resolves correctly through secrets_loader",
        "Test: State is UNAVAILABLE when remote server is down, with appropriate error message",
        "Test: Graceful fallback -- AI analysis returns without crash when remote is unreachable",
        "Tests use monkeypatch or unittest.mock for network operations (no real network calls)",
        "All tests pass, typecheck passes"
      ],
      "priority": "high",
      "passes": false,
      "notes": "",
      "dependencies": ["US-DBI-003"]
    },
    {
      "id": "US-OLL-001",
      "title": "Make Ollama Base URL Environment-Variable Configurable",
      "description": "As a developer, I need the Ollama base URL to support environment variable substitution so the Pi can use a different URL than the dev machine without changing config.json. Change ollamaBaseUrl in src/obd_config.json from hardcoded to ${OLLAMA_BASE_URL:http://localhost:11434}.",
      "acceptanceCriteria": [
        "Change ollamaBaseUrl in src/obd_config.json from http://localhost:11434 to ${OLLAMA_BASE_URL:http://localhost:11434}",
        "Verify secrets_loader.py resolves the placeholder correctly (it already supports ${VAR:default} syntax)",
        "Dev machine continues to work with localhost default (no .env change needed)",
        "Pi can override via .env: OLLAMA_BASE_URL=http://10.27.27.100:11434",
        "All existing tests pass (the default value is unchanged)",
        "Typecheck passes"
      ],
      "priority": "high",
      "passes": false,
      "notes": "",
      "dependencies": ["US-OLL-004"]
    },
    {
      "id": "US-OLL-002",
      "title": "Increase Timeouts for Remote Network Latency",
      "description": "As a developer, I need the API timeout to be configurable for remote servers where network latency adds to response time. Currently hardcoded in src/ai/types.py.",
      "acceptanceCriteria": [
        "Add aiAnalysis.apiTimeoutSeconds to src/obd_config.json with default 60 (was hardcoded 30s in types.py)",
        "Add aiAnalysis.healthTimeoutSeconds to src/obd_config.json with default 10 (was hardcoded 5s in types.py)",
        "OllamaManager.__init__ reads these values from config, falling back to the current constants if not present",
        "Pass configurable timeout to urllib.request.urlopen() calls instead of the constants",
        "Existing tests continue to pass (defaults are compatible)",
        "Typecheck passes"
      ],
      "priority": "medium",
      "passes": false,
      "notes": "",
      "dependencies": ["US-OLL-001"]
    },
    {
      "id": "US-OLL-003",
      "title": "Add Network Reachability Pre-Check",
      "description": "As a developer, I need the AI module to check network reachability to the Ollama host before attempting analysis, so it fails fast when WiFi is unavailable.",
      "acceptanceCriteria": [
        "Add a _checkNetworkReachable(self) -> bool method to OllamaManager",
        "Method extracts hostname from self._baseUrl and attempts a socket connection on the configured port with a 3-second timeout",
        "Method is called before _checkOllamaAvailable() in the health check flow",
        "If network unreachable: sets state to UNAVAILABLE, logs 'Network unreachable: <host>:<port>' at DEBUG level",
        "If network reachable: proceeds to normal Ollama health check",
        "Does not affect behavior when Ollama is on localhost (socket connect to localhost is fast)",
        "All existing tests pass, typecheck passes"
      ],
      "priority": "medium",
      "passes": false,
      "notes": "",
      "dependencies": ["US-OLL-002"]
    },
    {
      "id": "US-OLL-005",
      "title": "Create Ollama Server Setup Documentation",
      "description": "As the CIO, I need documentation on how to set up the Ollama server on Chi-srv-01 (10.27.27.100) so the Pi can connect to it.",
      "acceptanceCriteria": [
        "Create docs/ollama-server-setup.md",
        "Document: choosing a host machine (minimum specs: 8GB RAM, GPU recommended) - reference Chi-srv-01 as example",
        "Document: installing Ollama on the server (curl -fsSL https://ollama.com/install.sh | sh)",
        "Document: configuring Ollama to listen on all interfaces (OLLAMA_HOST=0.0.0.0)",
        "Document: pulling the required model (ollama pull gemma2:2b)",
        "Document: verifying the server is accessible (curl http://10.27.27.100:11434/)",
        "Document: firewall rules (allow port 11434 from Pi IP 10.27.27.28 or LAN subnet 10.27.27.0/24)",
        "Document: Pi-side configuration (set OLLAMA_BASE_URL=http://10.27.27.100:11434 in .env)",
        "Document: troubleshooting (connection refused, timeout, model not found)",
        "Document: optional systemd service for auto-start on the server",
        "Typecheck passes (n/a for docs, but no code changes should break typecheck)"
      ],
      "priority": "low",
      "passes": false,
      "notes": "",
      "dependencies": ["US-OLL-003"]
    }
  ]
}
