# B-027: EclipseTuner Client-Side Sync to Chi-Srv-01

| Field        | Value                  |
|--------------|------------------------|
| Priority     | High                   |
| Status       | Pending                |
| Category     | infrastructure         |
| Size         | M                      |
| Related PRD  | None (needs grooming)  |
| Dependencies | B-022, B-023           |
| Created      | 2026-02-01             |

## Description

Client-side changes to the EclipseTuner (Pi 5) application to support push-based delta sync to the Chi-Srv-01 companion service (`OBD2-Server`). This is the Pi-side counterpart to B-022.

When the Pi connects to DeathStarWiFi (detected by B-023), it:
1. Determines what data has changed since the last successful sync
2. Pushes delta rows to the companion service via HTTP API
3. Pushes database and log backups
4. Optionally requests AI analysis for completed drives

### Sync Model

```
Pi (SQLite)                          Chi-Srv-01 (MySQL)
┌──────────────────┐                 ┌──────────────────┐
│ sync_log table   │                 │ /sync endpoint   │
│ ┌──────────────┐ │   HTTP POST     │                  │
│ │ table_name   │ │ ─────────────> │ Upsert into      │
│ │ last_id      │ │   JSON payload  │ MySQL tables     │
│ │ last_sync_at │ │ <───────────── │                  │
│ └──────────────┘ │   Sync receipt  │ Return receipt   │
│                  │                 │ with row counts   │
│ Delta query:     │                 └──────────────────┘
│ WHERE id > ?     │
└──────────────────┘
```

### Tables to Sync

| Pi Table | Sync? | Rationale |
|----------|-------|-----------|
| realtime_data | Yes | Core sensor data for AI analysis |
| statistics | Yes | Post-drive stats |
| profiles | Yes | Profile definitions |
| vehicle_info | Yes | Vehicle metadata |
| ai_recommendations | Yes | Existing recommendations (for dedup) |
| connection_log | Yes | Drive start/end events |
| alert_log | Yes | Alert history |
| calibration_sessions | Yes | Calibration data |
| battery_log | No | Hardware telemetry, Pi-only |
| power_log | No | Hardware telemetry, Pi-only |

## Acceptance Criteria

- [ ] New `sync_log` table in SQLite schema (table_name, last_synced_id, last_synced_at, last_batch_id, status)
- [ ] `sync_log` created by `ObdDatabase.initialize()` (idempotent, added to ALL_SCHEMAS)
- [ ] Delta sync client reads sync_log, queries changed rows per table (WHERE id > last_synced_id)
- [ ] Pushes delta as JSON to companion service POST /sync endpoint
- [ ] API key read from .env (COMPANION_API_KEY) and sent as header
- [ ] On successful sync receipt, updates sync_log with new high-water mark
- [ ] On sync failure, logs error and retries next WiFi connection (no data loss)
- [ ] Backup push: sends SQLite DB file and recent log files to POST /backup
- [ ] Config: companion service URL and API key in obd_config.json / .env
- [ ] Tests validate sync_log table operations (insert, update, query delta)
- [ ] Tests validate delta calculation (only rows after last_synced_id returned)
- [ ] Tests validate sync failure does NOT advance the high-water mark

## Validation

- **Input**: Pi has new realtime_data rows since last sync, WiFi detected
- **Expected Output**: Delta rows pushed to companion API, sync_log updated
- **Database State**: sync_log shows updated last_synced_id per table after successful push
- **Test**: Unit tests for delta query logic, integration test with mocked HTTP endpoint

## Notes

- Depends on B-022 (companion service must exist to receive data) and B-023 (WiFi detection triggers sync)
- WiFi detection logic is in B-023 -- this item handles the sync/push once WiFi is confirmed
- API contract defined in B-022 PRD -- this item implements the client side of that contract
- Partial sync must be safe: if sync fails mid-table, the high-water mark is not advanced
