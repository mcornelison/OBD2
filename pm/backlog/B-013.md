# B-013: CI/CD Pipeline (Windows to Pi 5 Deployment)

| Field        | Value         |
|--------------|---------------|
| Priority     | High          |
| Status       | Pending       |
| Category     | deployment    |
| Size         | M             |
| Related PRD  | None          |
| Dependencies | B-012         |
| Created      | 2026-01-29    |

## Description

Create a simple CI/CD pipeline to deploy the application from the Windows development environment to the Raspberry Pi 5. The pipeline should handle code transfer, dependency installation, service restart, and deployment verification.

### Recommended Approach

A deploy script (`scripts/deploy.sh` or `scripts/deploy.py`) that:

1. **Syncs code** from Windows to Pi via rsync over SSH (or git pull on Pi)
2. **Installs/updates dependencies** via `pip install -r requirements-pi.txt` in a venv
3. **Runs database migration** (verify + initialize, see B-015)
4. **Restarts the systemd service** (if configured)
5. **Runs a smoke test** to verify deployment succeeded

### Alternatives Considered

| Approach | Pros | Cons |
|----------|------|------|
| rsync + SSH script | Simple, fast, no git needed on Pi | Manual trigger only |
| Git push â†’ Pi git pull | Version controlled, rollback easy | Requires git on Pi, webhook or cron |
| GitHub Actions + self-hosted runner | Automated on push, industry standard | Complex setup for solo dev |
| Fabric (Python SSH tool) | Python-native, scriptable, cross-platform | Extra dependency |

**Recommendation**: Start with a deploy script using rsync/SSH. Can evolve to GitHub Actions later if needed.

## Acceptance Criteria

- [ ] Single command deploys code from Windows to Pi
- [ ] Dependencies installed/updated automatically on Pi
- [ ] Application restarts after deployment
- [ ] Deployment script reports success/failure
- [ ] Rollback mechanism documented (at minimum: `git checkout` to previous version)
- [ ] Deploy script is idempotent (safe to run multiple times)
- [ ] Documentation: how to run a deployment, what it does, how to rollback

## Validation Script Requirements

- **Input**: Run deploy command from Windows
- **Expected Output**: Code appears on Pi, dependencies installed, service running, smoke test passes
- **Database State**: No data loss during deployment
- **Test Program**: Deploy script includes a post-deploy verification step that hits a health endpoint or runs `python src/main.py --dry-run` on the Pi

## Notes

Windows uses MINGW64/Git Bash, so rsync and ssh are available. The Pi must have SSH enabled (B-012). Consider adding a `make deploy` target for convenience.
