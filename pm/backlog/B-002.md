# B-002: Daily Backup to Google Drive

| Field        | Value         |
|--------------|---------------|
| Priority     | Medium        |
| Status       | Groomed       |
| Category     | infrastructure|
| Size         | M             |
| Related PRD  | pm/prds/prd-application-orchestration.md (partial -- backup stories US-TD-012, US-TD-013) |
| Dependencies | None          |
| Created      | 2026-01-25    |

## Description

Implement automated daily backup of the SQLite database to Google Drive with catch-up logic for missed backups. The Pi will be connected to home WiFi. If the database is corrupted and no backup exists, all data is lost. Recommended approach: use `rclone` for simplicity.

## Acceptance Criteria

- [ ] Daily backup runs automatically at configured time
- [ ] Catch-up backup triggers if >2 days since last backup
- [ ] Backups appear in configured Google Drive folder
- [ ] Old backups cleaned up (configurable retention, default 30)
- [ ] Backup failures logged without crashing the app
- [ ] Compression enabled (`.db.gz` format)
- [ ] Configuration added to `config.json` under `backup` key

## Validation Script Requirements

- **Input**: Trigger a manual backup via CLI or test
- **Expected Output**: Compressed backup file created locally, upload logged
- **Database State**: Backup metadata (last backup time) stored or retrievable
- **Test Program**: Write `tests/test_backup_manager.py` that verifies backup creation, compression, retention cleanup, and catch-up logic using mocked file system and mocked rclone calls

## Notes

Backup file naming: `obd_backup_YYYY-MM-DD_HHMMSS.db.gz`. Google Drive credentials stored via rclone's secure credential storage, not in config.json. Some stories already exist in the orchestration PRD.
