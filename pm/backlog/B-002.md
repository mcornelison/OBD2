# B-002: Comprehensive Backup Strategy (Database, Logs, Config)

| Field        | Value         |
|--------------|---------------|
| Priority     | Medium        |
| Status       | Groomed       |
| Category     | infrastructure|
| Size         | L             |
| Related PRD  | pm/prds/prd-application-orchestration.md (partial -- backup stories US-TD-012, US-TD-013) |
| Dependencies | B-012         |
| Created      | 2026-01-25    |
| Updated      | 2026-01-29 -- expanded scope from database-only to full backup strategy |

## Description

Implement a comprehensive backup strategy covering the SQLite database, application logs, and configuration files. Backups go to Google Drive via `rclone` when the Pi is connected to home WiFi. Must include catch-up logic for missed backups (vehicle may be stored for weeks).

### What Gets Backed Up

| Data | Location on Pi | Frequency | Retention |
|------|---------------|-----------|-----------|
| SQLite database | `data/obd.db` | Daily | 30 backups |
| Application logs | `logs/` | Weekly | 8 backups (2 months) |
| Configuration | `config.json`, `.env` | On change | 10 backups |

### Backup File Naming

```
obd_backup_db_YYYY-MM-DD_HHMMSS.db.gz
obd_backup_logs_YYYY-MM-DD_HHMMSS.tar.gz
obd_backup_config_YYYY-MM-DD_HHMMSS.tar.gz
```

## Acceptance Criteria

### Database Backup
- [ ] Daily backup runs automatically at configured time
- [ ] Catch-up backup triggers if >2 days since last backup
- [ ] Database backed up using SQLite `.backup` API (consistent snapshot)
- [ ] Compression enabled (`.db.gz` format)

### Log Backup
- [ ] Weekly log archive created
- [ ] Old log archives cleaned up per retention policy
- [ ] Active log file is not interrupted during backup

### Config Backup
- [ ] Config files backed up on change detection (or daily as fallback)
- [ ] `.env` secrets are included (encrypted or via rclone's secure transport)

### General
- [ ] All backups uploaded to configured Google Drive folder
- [ ] Old backups cleaned up per retention policy
- [ ] Backup failures logged without crashing the app
- [ ] Configuration added to `config.json` under `backup` key
- [ ] Manual backup can be triggered via CLI (`python scripts/backup.py --now`)
- [ ] Backup status/history queryable (`python scripts/backup.py --status`)
- [ ] rclone setup documented in deployment guide

## Validation Script Requirements

- **Input**: Trigger manual backup via CLI
- **Expected Output**: Compressed backup files created locally, upload logged for each type
- **Database State**: Backup metadata (last backup time per type) stored or retrievable
- **Test Program**: Write `tests/test_backup_manager.py` that verifies:
  1. Database backup creation and compression
  2. Log archive creation
  3. Config backup on change detection
  4. Retention cleanup (old files deleted)
  5. Catch-up logic (>2 days since last backup)
  6. All using mocked file system and mocked rclone calls

## Notes

Google Drive credentials stored via rclone's secure credential storage, not in config.json. Some stories already exist in the orchestration PRD (US-TD-012, US-TD-013). Consider whether restore functionality is needed (separate backlog item if so).
