# B-022: Chi-Srv-01 Companion Service (OBD2-Server)

| Field        | Value                  |
|--------------|------------------------|
| Priority     | High                   |
| Status       | Groomed                |
| Category     | infrastructure         |
| Size         | L                      |
| Related PRD  | pm/prds/prd-companion-service.md |
| Dependencies | B-016                  |
| Created      | 2026-01-31             |
| Updated      | 2026-02-01             |

## Description

A FastAPI companion service running on Chi-Srv-01 (10.27.27.120, Debian/Ubuntu Server) that provides AI analysis, data storage, and backup receiving for the EclipseTuner Pi 5. This service lives in a **separate GitHub repo** (`OBD2-Server`) with its own deployment, dependencies, and release cadence.

### Architecture

```
EclipseTuner (10.27.27.28)          Chi-Srv-01 (10.27.27.120)
┌──────────────────────┐              ┌──────────────────────────────┐
│  Eclipse OBD-II App  │  WiFi/LAN   │  OBD2-Server (FastAPI) │
│                      │ ──────────> │  ├── /sync    (delta sync)   │
│  Post-drive:         │   HTTP      │  ├── /analyze (AI analysis)  │
│  - Delta sync data   │   + API key │  ├── /backup  (backup recv)  │
│  - Request AI        │ <────────── │  ├── /health  (status)       │
│  - Push backups      │             │  │                            │
│                      │             │  ├── Ollama (LLM on CPU)     │
│  Trigger: connect to │             │  ├── MySQL (mirrored schema) │
│  DeathStarWiFi       │             │  └── systemd auto-start      │
└──────────────────────┘              └──────────────────────────────┘
```

### Key Decisions (Session 5, 2026-02-01)

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Repo | `OBD2-Server` (separate) | Different deployment target, deps, release cadence |
| Framework | FastAPI | Async, auto OpenAPI docs, easy testing |
| Auth | API key (shared secret) | Simple, sufficient for home LAN |
| Server DB | MySQL | Mirror SQLite schema + server extras (synced_at, source_device) |
| Sync model | Push-based delta | Pi initiates, sends only changed rows since last sync |
| Sync tracking | Sync log table on Pi | Per-table last_id and last_timestamp (B-027) |
| AI trigger | Auto on drive data + on-demand /analyze | Both modes supported |
| LLM model | Llama 3.1 8B (fast) or 70B (quality) | CPU inference with 128GB RAM |
| Dashboard | Deferred | Future sprint |
| NAS replication | Deferred | Future B- item |

### Server Specs (Finalized 2026-02-02)

- **OS**: Debian 13 (trixie)
- **CPU**: Intel Core i7-5960X @ 3.00GHz (8 cores / 16 threads)
- **RAM**: 128GB DDR4 (8 x 16GB @ 2666MHz)
- **GPU**: NVIDIA GeForce GT 730 (display only, not for AI)
- **Disk**: 2TB RAID 5 SSD at `/mnt/raid5`
- **NAS Mount**: Chi-NAS-01 projects at `/mnt/projects`
- **Network**: 10.27.27.120 on DeathStarWiFi (10.27.27.0/24)
- **Ollama**: CPU inference only (128GB RAM enables large models like Llama 3.1 70B)

## Scope

**Server-side only** (companion service in `OBD2-Server` repo). Client-side sync changes to EclipseTuner are tracked in B-027.

### In Scope

1. FastAPI service with API key auth
2. Ollama manager -- host Ollama, expose /analyze endpoint, auto-analyze on drive receipt
3. MySQL database -- mirrored schema from Pi SQLite + server-only columns
4. Delta sync receiver -- accept push from Pi, upsert into MySQL, acknowledge
5. Backup receiver -- accept DB/log file uploads, store with timestamps and rotation
6. Health endpoint -- service status, Ollama status, MySQL status, last sync timestamp
7. systemd service -- auto-start on Chi-Srv-01 boot
8. API contract documentation (endpoints, schemas, versioning)

### Out of Scope (Deferred)

- Data dashboard (future sprint)
- NAS replication to Chi-NAS-01 (future B- item)
- Client-side sync code on EclipseTuner (B-027)

## Acceptance Criteria

- [ ] FastAPI service starts on Chi-Srv-01, listens on configured port
- [ ] API key auth required on all endpoints (except /health)
- [ ] POST /sync accepts delta data (JSON), upserts into MySQL, returns sync receipt
- [ ] POST /analyze triggers AI analysis on specified drive data, returns recommendations
- [ ] Auto-analysis fires when new drive data arrives via /sync
- [ ] POST /backup accepts file uploads, stores with timestamp naming and rotation
- [ ] GET /health returns service status, Ollama status, MySQL status, last sync timestamp
- [ ] MySQL schema mirrors Pi SQLite (realtime_data, statistics, profiles, vehicle_info, ai_recommendations, connection_log) plus server columns (synced_at, source_device, sync_batch_id)
- [ ] Ollama running with configured model, health-checked before analysis
- [ ] Service runs as systemd unit, auto-starts on boot
- [ ] API contract documented (OpenAPI spec auto-generated by FastAPI)
- [ ] Setup guide: OS deps, MySQL setup, Ollama install, model pull, service install
- [ ] All endpoints have tests

## Validation

- **Input**: EclipseTuner pushes drive data via /sync, requests analysis via /analyze
- **Expected Output**: Data appears in MySQL, AI recommendations returned
- **Database State**: MySQL tables contain synced rows with synced_at timestamps
- **Test**: Integration tests using httpx TestClient against FastAPI app

## Notes

- Ollama model: Llama 3.1 8B (fast iteration) or 70B (higher quality). CPU inference with 128GB RAM.
- Pi-side changes (sync log table, delta sync client, API key config) tracked in B-027.
- API contract is the critical interface between repos -- versioned, documented.
- Battery_log and power_log are NOT synced (hardware telemetry stays on Pi only).
